---
title: 'moltenPPCA'
author: "Ko ABE"
date: "3/22/2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{moltenPPCA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE, fig.width = 14, fig.height = 7, fig.align = "center"}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

Principal component analysis (PCA) is widely used in exploratory data analysis. 

Commonly, PCA and probabilistic PCA (PPCA) find the matrix $Z$ and $W$ such that $Y \approx ZW$ with given data matrix $Y$.

However, If the data contains some side-information (such as, time, age, sex, or treatment), matrix format will probably failed to represent data structure. 

On the other hand, *tidy* data format are flexible. Now, we introduce *tidy* version of PPCA.

## Model

Now, We consider the probabilistic model for observed variable $y_n$ as following; 
$$
y_n \sim \mathcal{N}\left(\sum_{l=1}^L \prod_{d=1}^Dv_{dl}^{x_{nd}}, \lambda^{-1}\right),
$$
where $\mathcal{N}(\mu,\sigma^2)$ is normal distribution with mean $\mu$ and variance $\sigma^2$. The precision $\lambda$ is user-tuning parameter.

Next, we set normal prior distribution for unobserved variable $v_{dl}$;
$$
v_{dl} \sim \mathcal{N}(0,\tau^{-1}).
$$

### Example: matrix factorization

We assume that we obtain two response from an experiment with the two subjects. Let matrix $Y=(y_{nk})$ be the result of this experiment and its $(n,k)$-element be $k$-th response from subject $n$. This data-set $\mathcal{D}$ can be expressed as following:
$$
\mathcal{D} = \{ (1, 1, y_{1}), (2, 1, y_{2}), (1, 2, y_{3}), (2,2, y_{4})\},
$$
where $i$ of triple $(i,j,h)$ represent subject, and $j$ is item dummy variable. 
In this notation, the indices of the $y_{nk}$ can be regarded as explanatory variables as following:
$$
\boldsymbol{x}_{1j} = \{1,0\}, \quad \boldsymbol{x}_{2j} = \{0,1\}
$$
Under the assumption of proposal model, $y_{nk}$ can be approximated as:
$$
y_h ~ (\, =y_{nk}) \approx \sum_{l=1}^L \prod_{d=1}^D v_{dl}^{x_{hd}}.
$$

This equation is equivalent to the matrix factorization:
$$
y_{nk} = y_{h} \approx \sum_{l=1}^L z_{nl}w_{lk}.
$$
The proposed model contains matrix factorization as special case.

### Example: missing data

We consider the situation where there are subjects that are observed at the first time but not at the second time.
If such data is held as a three-dimensional array, there will be a missing value at the second time point.

The proposed model can naturally treat such missing data. If the subjects does not exist at the second time point, there is no corresponding row in the data but there is no problem for estimation procedure.

## Estimation

Under the model assumption and using mean-field approximation, we get following variational approximated posterior distribution; 
$$
q(v_{dl})= \mathcal{N}(\hat \mu_{dl},\hat \sigma_{dl}), 
$$
where $\hat \mu_{dl}$ is defined by,
$$
\hat \mu_{dl} =\frac{\sum_{n=1}^N x_{nd}\prod_{d' \neq d} \langle v_{d'l} \rangle ^{x_{nd'}} \left[y_n -\sum_{l'\neq l}\prod_{j=1}  \langle v_{jl'} \rangle ^{x_{nj}}  \right]}{\tau/\lambda + \left( \sum_{n=1}^N x_{nd}\prod_{d\neq d'} \langle v_{d'l}^{2} \rangle ^{x_{nd'}} \right)},
$$
and $\hat \sigma_{dl}$ is
$$
{\hat{\sigma}}^2 =\left(\tau + \lambda \left\{\sum_{n=1}^N x_{nd}\prod_{d' \neq d}  \langle v_{d'l}^2 \rangle ^{x_{nd'}}\right\} \right)^{-1},
$$
where $\langle v_{dl} \rangle$ is expectation of $v_{dl}$ under the all of variational posterior distributions $q(v_{dl})$ except itself.


## Workflow

```{r run}
library(moltenPPCA)
library(tidyr)
library(dplyr)
library(ggplot2)
library(moltenPPCA)
iris_g <- mutate(iris, id=factor(row_number())) %>% 
  gather(key,value,-id,-Species)

set.seed(2222)
out <- mPPCA_vb(value~id+key-1,data=iris_g,L=2, iter=200)
qplot(1:200,out$logloss, geom = "line")+
  labs(x="iter", y="log-loss")+
  theme_minimal(16)
```

```{r plot}
iii <- (out$indices[1]+1):out$indices[1+1]
df <- data.frame(out$mean[iii,], species=iris$Species)

ggplot(df, aes(X1,X2,colour=species))+
  geom_point(alpha=0.7, size=2)+
  theme_minimal(16)
```
